const s="locanote-cache-v1",c=["/","/manifest.json","/favicon.svg"];self.addEventListener("install",t=>{console.log("[SW] Installing service worker..."),t.waitUntil(caches.open(s).then(e=>(console.log("[SW] Caching static assets"),e.addAll(c))).then(()=>(console.log("[SW] Installation complete"),self.skipWaiting())).catch(e=>{console.error("[SW] Cache installation failed:",e)}))});self.addEventListener("activate",t=>{console.log("[SW] Activating service worker..."),t.waitUntil(caches.keys().then(e=>Promise.all(e.filter(n=>n!==s).map(n=>(console.log("[SW] Deleting old cache:",n),caches.delete(n))))).then(()=>(console.log("[SW] Activation complete"),self.clients.claim())))});self.addEventListener("fetch",t=>{const{request:e}=t,n=new URL(e.url);e.method==="GET"&&(n.protocol==="wss:"||n.protocol==="ws:"||n.origin===self.location.origin&&(i(e)?t.respondWith(l(e)):r(e)&&t.respondWith(f(e))))});function i(t){const e=new URL(t.url);return[".js",".css",".svg",".png",".jpg",".jpeg",".gif",".woff",".woff2"].some(o=>e.pathname.endsWith(o))}function r(t){var e;return(e=t.headers.get("accept"))==null?void 0:e.includes("text/html")}async function l(t){const e=await caches.open(s),n=await e.match(t);if(n)return h(t,e),n;try{const o=await fetch(t);return o.ok&&e.put(t,o.clone()),o}catch(o){return console.error("[SW] Network fetch failed:",o),new Response("Offline - Resource not available",{status:503,statusText:"Service Unavailable"})}}async function f(t){const e=await caches.open(s);try{const n=await fetch(t);return n.ok&&e.put(t,n.clone()),n}catch{console.log("[SW] Network failed, trying cache:",t.url);const o=await e.match(t);if(o)return o;const a=await e.match("/");return a||new Response("You are offline",{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"text/plain"}})}}async function h(t,e){try{const n=await fetch(t);n.ok&&e.put(t,n)}catch{}}self.addEventListener("message",t=>{t.data==="SKIP_WAITING"&&self.skipWaiting()});self.addEventListener("sync",t=>{t.tag==="sync-notes"&&t.waitUntil(d())});async function d(){console.log("[SW] Background sync triggered"),(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:"SYNC_COMPLETE",timestamp:Date.now()})})}self.addEventListener("push",t=>{var n;const e=((n=t.data)==null?void 0:n.json())??{};t.waitUntil(self.registration.showNotification(e.title??"Locanote",{body:e.body??"New activity",icon:"/favicon.svg",badge:"/favicon.svg",tag:e.tag??"default",requireInteraction:!1}))});self.addEventListener("notificationclick",t=>{t.notification.close(),t.waitUntil(self.clients.openWindow("/app"))});console.log("[SW] Service worker loaded");
