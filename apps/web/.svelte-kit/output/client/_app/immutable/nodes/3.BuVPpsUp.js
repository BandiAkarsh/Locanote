import{c as v,a as p,f as O}from"../chunks/Bgm4i-1x.js";import{x as T,o as D,y as _,z as K,e as x,a1 as B,t as V,l as H,v as m}from"../chunks/BKD1GJOj.js";import{i as W}from"../chunks/D94Q0doQ.js";import{g as y,h as M}from"../chunks/DnUxGdOX.js";import{A as F,R as q}from"../chunks/BzuvfmtD.js";import{a as n}from"../chunks/BnJyyoW3.js";function I(){const e=new Uint8Array(32);return crypto.getRandomValues(e),e.buffer}function E(){return crypto.randomUUID()}function P(){return crypto.randomUUID()}async function R(e){return await(await y()).add("users",e),e}async function G(e){return(await y()).get("users",e)}async function w(e){return(await y()).transaction("users").store.index("by-username").get(e)}async function Y(e){return await(await y()).put("users",e),e}async function L(e){const t=await G(e);if(t)return t.lastLoginAt=Date.now(),Y(t)}async function N(e){return!!await w(e)}async function S(e){return await(await y()).add("credentials",e),e}async function C(e){return(await y()).transaction("credentials").store.index("by-user").getAll(e)}async function j(e,t){return(await C(e)).find(s=>s.type===t)}async function z(e){try{let t;const s={challenge:I(),timeout:12e4,rpId:window.location.hostname,allowCredentials:[],userVerification:"preferred"};if(t){const l=(await C(t)).filter(d=>d.type==="passkey"&&d.credentialId);if(l.length===0)return{success:!1,error:"No passkey found for this user. Please use password login or register a passkey.",code:"NO_PASSKEY"};s.allowCredentials=l.map(d=>({type:"public-key",id:d.credentialId,transports:["internal","hybrid"]}))}const i=await navigator.credentials.get({publicKey:s});if(!i)return{success:!1,error:"Authentication cancelled.",code:"CANCELLED"};if(!t){const u=A(i.rawId);return{success:!1,error:"Please enter your username to login.",code:"USERNAME_REQUIRED"}}const c=await w(e);return c&&await L(c.id),{success:!0,userId:t,username:c?.username||e,method:"passkey",credentialId:A(i.rawId)}}catch(t){if(console.error("Passkey login error:",t),t instanceof DOMException){if(t.name==="NotAllowedError")return{success:!1,error:"Authentication failed. Please verify with your passkey.",code:"NOT_ALLOWED"};if(t.name==="AbortError")return{success:!1,error:"Login cancelled.",code:"ABORTED"}}return{success:!1,error:"Login failed. Please try again.",code:"UNKNOWN_ERROR"}}}function A(e){const t=new Uint8Array(e);let r="";for(let s=0;s<t.byteLength;s++)r+=String.fromCharCode(t[s]);return btoa(r)}const b=8,X=1e5,Q=256,Z="SHA-256";function J(e){return e.length<b?{isValid:!1,error:`Password must be at least ${b} characters long.`}:/[A-Z]/.test(e)?/[0-9]/.test(e)?{isValid:!0,error:null}:{isValid:!1,error:"Password must contain at least one number."}:{isValid:!1,error:"Password must contain at least one uppercase letter."}}function $(){const e=new Uint8Array(16);return crypto.getRandomValues(e),k(e)}async function U(e,t){const r=new TextEncoder().encode(e),s=re(t),i=await crypto.subtle.importKey("raw",r,{name:"PBKDF2"},!1,["deriveBits"]),c=await crypto.subtle.deriveBits({name:"PBKDF2",salt:s,iterations:X,hash:Z},i,Q);return k(new Uint8Array(c))}async function ee(e,t){try{const r=J(t);if(!r.isValid)return{success:!1,error:r.error||"Invalid password.",code:"INVALID_PASSWORD"};if(await N(e))return{success:!1,error:"Username already taken. Please choose a different one.",code:"USERNAME_EXISTS"};const i=E(),c=P(),u=$(),l=await U(t,u),d=Date.now();return await R({id:i,username:e,createdAt:d,lastLoginAt:d}),await S({id:c,userId:i,type:"password",passwordHash:l,salt:u,createdAt:d}),{success:!0,userId:i,username:e,credentialId:c}}catch(r){return console.error("Password registration error:",r),{success:!1,error:"Failed to create account. Please try again.",code:"UNKNOWN_ERROR"}}}async function te(e,t){try{const r=await j(e,"password");return!r||!r.passwordHash||!r.salt?!1:await U(t,r.salt)===r.passwordHash}catch(r){return console.error("Password verification error:",r),!1}}function k(e){let t="";for(let r=0;r<e.byteLength;r++)t+=String.fromCharCode(e[r]);return btoa(t)}function re(e){const t=atob(e),r=new Uint8Array(t.length);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return r.buffer}async function se(e,t){try{if(!e||!t)return{success:!1,error:"Please enter both username and password.",code:"MISSING_CREDENTIALS"};const r=await w(e);return r?await te(r.id,t)?(await L(r.id),{success:!0,userId:r.id,username:r.username,method:"password",credentialId:r.id}):{success:!1,error:"Invalid username or password.",code:"INVALID_CREDENTIALS"}:{success:!1,error:"Invalid username or password.",code:"INVALID_CREDENTIALS"}}catch(r){return console.error("Password login error:",r),{success:!1,error:"Login failed. Please try again.",code:"UNKNOWN_ERROR"}}}async function ae(e){try{if(await N(e))return{success:!1,error:"Username already taken. Please choose a different one.",code:"USERNAME_EXISTS"};const r=E(),s=P(),c={challenge:I(),rp:{name:"Locanote",id:window.location.hostname},user:{id:new TextEncoder().encode(r),name:e,displayName:e},pubKeyCredParams:[{type:"public-key",alg:-7},{type:"public-key",alg:-257}],timeout:3e5,authenticatorSelection:{authenticatorAttachment:void 0,residentKey:"required",requireResidentKey:!0,userVerification:"preferred"},attestation:"none"},u=await navigator.credentials.create({publicKey:c});if(!u)return{success:!1,error:"Registration cancelled. Please try again.",code:"CANCELLED"};const l=u.response,d=u.rawId,h=l.getPublicKey(),g=l.attestationObject,a=Date.now();return await R({id:r,username:e,createdAt:a,lastLoginAt:a}),await S({id:s,userId:r,type:"passkey",publicKey:h||void 0,credentialId:d,createdAt:a}),{success:!0,userId:r,username:e,credentialId:s}}catch(t){if(console.error("Passkey registration error:",t),t instanceof DOMException){if(t.name==="NotAllowedError")return{success:!1,error:"Permission denied. Please allow access to your authenticator.",code:"NOT_ALLOWED"};if(t.name==="AbortError")return{success:!1,error:"Registration cancelled.",code:"ABORTED"};if(t.name==="SecurityError")return{success:!1,error:"WebAuthn requires a secure context (HTTPS or localhost).",code:"SECURITY_ERROR"}}return{success:!1,error:"Failed to create passkey. Please try again.",code:"UNKNOWN_ERROR"}}}var ne=O('<meta name="description" content="A secure, local-first note-taking app with real-time collaboration. Your notes stay on your device."/>');function fe(e,t){T(t,!0),D(()=>{n.initialize()});let r=H("login");async function s(){n.setLoading("Authenticating with passkey...");const a=await z();a.success?n.handleAuthSuccess(a):n.handleAuthError(a)}async function i(a,o){n.setLoading("Authenticating...");const f=await se(a,o);f.success?n.handleAuthSuccess(f):n.handleAuthError(f)}async function c(a){n.setLoading("Creating your account...");const o=await ae(a);o.success?n.handleAuthSuccess({success:!0,userId:o.userId,username:o.username,method:"passkey",credentialId:o.credentialId}):n.handleAuthError(o)}async function u(a,o){n.setLoading("Creating your account...");const f=await ee(a,o);f.success?n.handleAuthSuccess({success:!0,userId:f.userId,username:f.username,method:"password",credentialId:f.credentialId}):n.handleAuthError(f)}var l=v();M("1uha8ag",a=>{var o=ne();x(()=>{B.title="Locanote - Local-First Collaborative Notes"}),p(a,o)});var d=_(l);{var h=a=>{F(a,{onPasskeyLogin:s,onPasswordLogin:i,onSwitchToRegister:()=>m(r,"register"),get authState(){return n.state},set authState(o){n.state=o}})},g=a=>{q(a,{onRegisterPasskey:c,onRegisterPassword:u,onSwitchToLogin:()=>m(r,"login"),get authState(){return n.state},set authState(o){n.state=o}})};W(d,a=>{V(r)==="login"?a(h):a(g,!1)})}p(e,l),K()}export{fe as component};
